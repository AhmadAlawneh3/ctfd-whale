{% extends "admin/base.html" %}

{% block content %}
    <div class="jumbotron">
        <div class="container">
            <h1>CTFd Whale Configuration</h1>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <a class="nav-link rounded-0 active" href="#settings" role="tab" data-toggle="tab">Settings</a>
                        <a class="nav-link rounded-0" href="/plugins/ctfd-whale/admin/containers">Instances</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-9">
                {% for error in errors %}
                    <div class="alert alert-danger alert-dismissable" role="alert">
                        <span class="sr-only">Error:</span>
                        {{ error }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">Ã—</span>
                        </button>
                    </div>
                {% endfor %}

                <div class="tab-content">
                    {% include "config/form.html" %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        if ($ === undefined) $ = CTFd.lib.$;

        function update_configs(obj) {
            Object.keys(obj).forEach(function (x) {
                if (obj[x] === "true") {
                    obj[x] = true;
                } else if (obj[x] === "false") {
                    obj[x] = false;
                }
            });

            CTFd.fetch("/api/v1/plugins/ctfd-whale/admin/settings", {
                method: "PATCH",
                credentials: "same-origin",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(obj)
            })
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    window.location.reload();
                });
        }

        $(function () {
            $(".config-section > form:not(.form-upload)").submit(function (e) {
                e.preventDefault();
                update_configs($(this).serializeJSON());
            });
        });
    </script>
{% endblock %}
